- match:
    name: "^model\\.layers\\.(0|[1-9]|[1234][0-9])\\."
    class: ktransformers.models.modeling_qwen2_moe.Qwen2MoeRotaryEmbedding
  replace:
    class: ktransformers.operators.RoPE.RotaryEmbedding
    kwargs:
      generate_device: "cuda:0"
      prefill_device: "cuda:0"
- match:
    name: "^model\\.layers\\.([56789][0-9])\\."
    class: ktransformers.models.modeling_qwen2_moe.Qwen2MoeRotaryEmbedding
  replace:
    class: ktransformers.operators.RoPE.RotaryEmbedding
    kwargs:
      generate_device: "cuda:1"
      prefill_device: "cuda:1"
- match:
    name: "^model\\.layers\\.(0|[1-9]|[1234][0-9])\\."  # regular expression 
    class: torch.nn.Linear  # only match modules matching name and class simultaneously
  replace:
    class: ktransformers.operators.linear.KTransformersLinear  # optimized Kernel on quantized data types
    kwargs:
      generate_device: "cuda:0"
      prefill_device: "cuda:0"
      generate_op: "KLinearTorch"
      prefill_op: "KLinearTorch"
- match:
    name: "^model\\.layers\\.([56789][0-9])\\."  # regular expression 
    class: torch.nn.Linear  # only match modules matching name and class simultaneously
  replace:
    class: ktransformers.operators.linear.KTransformersLinear  # optimized Kernel on quantized data types
    kwargs:
      generate_device: "cuda:1"
      prefill_device: "cuda:1"
      generate_op: "KLinearTorch"
      prefill_op: "KLinearTorch"

#- match:
#    name: "^model\\.layers\\.(0|[1-9]|[1234][0-9])\\.(?!mlp.gate).*$"  # regular expression 
#    class: torch.nn.Linear  # only match modules matching name and class simultaneously
#  replace:
#    class: ktransformers.operators.linear.KTransformersLinear  # optimized Kernel on quantized data types
#    kwargs:
#      generate_device: "cuda:0"
#      prefill_device: "cuda:0"
#      generate_op: "KLinearTorch"
#      prefill_op: "KLinearTorch"
#- match:
#    name: "^model\\.layers\\.([56789][0-9])\\.(?!mlp.gate).*$"  # regular expression 
#    class: torch.nn.Linear  # only match modules matching name and class simultaneously
#  replace:
#    class: ktransformers.operators.linear.KTransformersLinear  # optimized Kernel on quantized data types
#    kwargs:
#      generate_device: "cuda:1"
#      prefill_device: "cuda:1"
#      generate_op: "KLinearTorch"
#      prefill_op: "KLinearTorch"

- match:
    name: "^model\\.layers\\.(0|[1-9]|[1234][0-9])\\.mlp$"
  replace:
    class: ktransformers.operators.experts.KQwen3MoeSparseMoeBlock     # mlp module with custom forward function
    kwargs:
      generate_device: "cuda:0"
      prefill_device: "cuda:0"
- match:
    name: "^model\\.layers\\.([56789][0-9])\\.mlp$"
  replace:
    class: ktransformers.operators.experts.KQwen3MoeSparseMoeBlock     # mlp module with custom forward function
    kwargs:
      generate_device: "cuda:1"
      prefill_device: "cuda:1"

- match:
    name: "^model\\.layers\\.(0|[1-9]|[1234][0-9])\\.mlp\\.experts$"
  replace:
    class: ktransformers.operators.experts.KTransformersExperts     # custom MoE Kernel with expert paralleism
    kwargs:
      prefill_device: "cuda:0"
      prefill_op: "KExpertsTorch"
      generate_device: "cpu"
      generate_op: "KSFTExpertsCPU"
      out_device: "cuda:0"
      backend: "AMXInt8" # or "AMXInt8" or "AMXBF16" or "llamafile"
  recursive: False # don't recursively inject submodules of this module

- match:
    name: "^model\\.layers\\.([56789][0-9])\\.mlp\\.experts$"
  replace:
    class: ktransformers.operators.experts.KTransformersExperts     # custom MoE Kernel with expert paralleism
    kwargs:
      prefill_device: "cuda:1"
      prefill_op: "KExpertsTorch"
      generate_device: "cpu"
      generate_op: "KSFTExpertsCPU"
      out_device: "cuda:1"
      backend: "AMXInt8" # or "AMXInt8" or "AMXBF16" or "llamafile"
  recursive: False # don't recursively inject submodules of this module

- match:
    name: "^model\\.layers\\.(0|[1-9]|[1234][0-9])\\.self_attn$"
  replace:
    class: ktransformers.operators.attention.KQwen3MoeAttention # optimized MLA implementation
    kwargs:
      generate_device: "cuda:0"
      prefill_device: "cuda:0"
- match:
    name: "^model\\.layers\\.([56789][0-9])\\.self_attn$"
  replace:
    class: ktransformers.operators.attention.KQwen3MoeAttention # optimized MLA implementation
    kwargs:
      generate_device: "cuda:1"
      prefill_device: "cuda:1"
- match:
    name: "^model.embed_tokens"
  replace:
    class: "default"
    kwargs:
      generate_device: "cpu"
      prefill_device: "cpu"

- match:
    name: "^model$"
  replace:
    class: "ktransformers.operators.models.KQwen2MoeModel"
    kwargs:
      per_layer_prefill_intput_threshold: 0
      transfer_map:
        50: "cuda:1"

- match:
    name: "^lm_head"
    class: torch.nn.Linear
  replace:
    class: ktransformers.operators.linear.KTransformersLinear
    kwargs:
      generate_device: "cuda:0"
      prefill_device: "cuda:0"
      generate_op: "KLinearTorch"
      prefill_op: "KLinearTorch"

- match:
    name: "(^model\\.layers\\.(0|[1-9]|[1234][0-9])\\.)"
  replace:
    class: "default"
    kwargs:
      generate_device: "cuda:0"
      prefill_device: "cuda:0"


- match:
    name: "(^model\\.layers\\.([56789][0-9])\\.)|(model.norm)"
  replace:
    class: "default"
    kwargs:
      generate_device: "cuda:1"
      prefill_device: "cuda:1"
