name: Release to PyPI

on:
  push:
    branches:
      - main
    paths:
      - "version.py"
  workflow_dispatch:
    inputs:
      test_pypi:
        description: 'Publish to TestPyPI instead of PyPI (for testing)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: read

jobs:
  build-kt-kernel:
    name: Build kt-kernel (Python ${{ matrix.python-version }})
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake libhwloc-dev pkg-config

      - name: Setup CUDA 12.6
        uses: Jimver/cuda-toolkit@v0.2.11
        with:
          cuda: '12.6.0'
          method: 'network'
          sub-packages: '["nvcc", "cudart", "cuda-libraries-dev"]'

      - name: Verify CUDA installation
        run: |
          nvcc --version
          echo "CUDA_HOME=$CUDA_HOME"
          ls -la $CUDA_HOME/bin/

      - name: Install Python build tools
        run: |
          python -m pip install --upgrade pip
          pip install build wheel setuptools

      - name: Build kt-kernel wheel (multi-variant)
        working-directory: kt-kernel
        env:
          CPUINFER_BUILD_ALL_VARIANTS: '1'
          CPUINFER_USE_CUDA: '1'
          CPUINFER_BUILD_TYPE: 'Release'
          CPUINFER_PARALLEL: '4'
          CUDA_HOME: /usr/local/cuda-12.6
          PATH: /usr/local/cuda-12.6/bin:${{ env.PATH }}
        run: |
          echo "Building kt-kernel with all CPU variants (AMX, AVX512, AVX2)"
          python -m build --wheel --no-isolation -v

      - name: List generated wheels
        working-directory: kt-kernel
        run: |
          echo "Generated wheels:"
          ls -lh dist/

      - name: Test wheel import
        working-directory: kt-kernel
        run: |
          pip install dist/*.whl
          python -c "import kt_kernel; print('âœ“ Import successful'); print(f'CPU variant detected: {kt_kernel.__cpu_variant__}'); print(f'Version: {kt_kernel.__version__}')"

      - name: Verify wheel contains all variants
        working-directory: kt-kernel
        run: |
          echo "Checking wheel contents for CPU variants..."
          python -m zipfile -l dist/*.whl | grep "_kt_kernel_ext_" || echo "ERROR: No variant .so files found!"
          python -m zipfile -l dist/*.whl | grep "_kt_kernel_ext_amx.cpython" && echo "âœ“ AMX variant found" || echo "âœ— AMX variant missing"
          python -m zipfile -l dist/*.whl | grep "_kt_kernel_ext_avx512.cpython" && echo "âœ“ AVX512 variant found" || echo "âœ— AVX512 variant missing"
          python -m zipfile -l dist/*.whl | grep "_kt_kernel_ext_avx2.cpython" && echo "âœ“ AVX2 variant found" || echo "âœ— AVX2 variant missing"

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v3
        with:
          name: kt-kernel-wheels-py${{ matrix.python-version }}
          path: kt-kernel/dist/*.whl
          retention-days: 7

  publish-pypi:
    name: Publish to PyPI
    needs: build-kt-kernel
    runs-on: ubuntu-latest
    if: github.repository == 'kvcache-ai/ktransformers' && github.ref == 'refs/heads/main'
    environment: prod
    permissions:
      id-token: write  # For trusted publishing (OIDC)
      contents: read

    steps:
      - name: Download all wheel artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts/

      - name: Organize wheels into dist/
        run: |
          mkdir -p dist/
          find artifacts/ -name "*.whl" -exec cp {} dist/ \;
          echo "Wheels to publish:"
          ls -lh dist/

      - name: Get version from wheel
        id: get_version
        run: |
          # Extract version from first wheel filename
          wheel_name=$(ls dist/*.whl | head -1 | xargs basename)
          # Extract version (format: kt_kernel-X.Y.Z-...)
          version=$(echo "$wheel_name" | sed 's/kt_kernel-\([0-9.]*\)-.*/\1/')
          echo "VERSION=$version" >> $GITHUB_OUTPUT
          echo "Publishing version: $version"

      - name: Publish to TestPyPI (if requested)
        if: github.event.inputs.test_pypi == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}
          skip-existing: true
          print-hash: true

      - name: Publish to PyPI
        if: github.event.inputs.test_pypi != 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: true
          print-hash: true

      - name: Create release summary
        run: |
          echo "## ðŸŽ‰ kt-kernel v${{ steps.get_version.outputs.VERSION }} Published to PyPI" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "pip install kt-kernel==${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Published Wheels" >> $GITHUB_STEP_SUMMARY
          ls -1 dist/ >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### CPU Variants Included" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… AMX (Intel Sapphire Rapids+)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… AVX512 (Intel Skylake-X/Ice Lake/Cascade Lake)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… AVX2 (Maximum compatibility)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "PyPI link: https://pypi.org/project/kt-kernel/${{ steps.get_version.outputs.VERSION }}/" >> $GITHUB_STEP_SUMMARY
